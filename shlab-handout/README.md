## ![img](https://cnchen2000.oss-cn-shanghai.aliyuncs.com/img/logo.png)      å¤§æ•°æ®ä¸“ä¸šLinuxç³»ç»Ÿç¼–ç¨‹å®éªŒæŠ¥å‘ŠğŸ“

| ä¸“ä¸š                 | å­¦å·         | å§“å         |
| :------------------- | ------------ | ------------ |
| æ•°æ®ç§‘å­¦ä¸å¤§æ•°æ®æŠ€æœ¯ | 210424071    | æ±Ÿæˆ         |
| **è¯¾ç¨‹åç§°**         | **å®éªŒåç§°** | **å®Œæˆæ—¥æœŸ** |
| Linuxç³»ç»Ÿç¼–ç¨‹        | Shell-lab    | 2023.11.20   |

- [      å¤§æ•°æ®ä¸“ä¸šLinuxç³»ç»Ÿç¼–ç¨‹å®éªŒæŠ¥å‘ŠğŸ“](#------å¤§æ•°æ®ä¸“ä¸šlinuxç³»ç»Ÿç¼–ç¨‹å®éªŒæŠ¥å‘Š)
  - [ä¸€ å®éªŒç›®æ ‡](#ä¸€-å®éªŒç›®æ ‡)
  - [äºŒ å®éªŒè¦æ±‚](#äºŒ-å®éªŒè¦æ±‚)
  - [ä¸‰ å®éªŒç¯å¢ƒ](#ä¸‰-å®éªŒç¯å¢ƒ)
  - [å›› å‰ç½®çŸ¥è¯†](#å››-å‰ç½®çŸ¥è¯†)
    - [signalä¿¡å·å¤„ç†](#signalä¿¡å·å¤„ç†)
    - [waitpidå‡½æ•°](#waitpidå‡½æ•°)
    - [killå‡½æ•°](#killå‡½æ•°)
    - [sigprocmaskå‡½æ•°](#sigprocmaskå‡½æ•°)
  - [äº” å®éªŒå†…å®¹](#äº”-å®éªŒå†…å®¹)
    - [1  sigint\_handler](#1--sigint_handler)
    - [2  sigtstp\_handler](#2--sigtstp_handler)
    - [3  sigchld\_handler](#3--sigchld_handler)
    - [4  waitfg](#4--waitfg)
    - [5  builtin\_cmd](#5--builtin_cmd)
    - [6  do\_bgfg](#6--do_bgfg)
    - [7  sigtstp\_handler](#7--sigtstp_handler)
    - [æµ‹è¯•](#æµ‹è¯•)
  - [å…­ å®éªŒå¿ƒå¾—](#å…­-å®éªŒå¿ƒå¾—)


### ä¸€ å®éªŒç›®æ ‡

è¿™é¡¹ä»»åŠ¡çš„ç›®çš„æ˜¯æ›´åŠ ç†Ÿæ‚‰è¿‡ç¨‹æ§åˆ¶å’Œä¿¡å·çš„æ¦‚å¿µã€‚ä¸ºæ­¤ï¼Œä½ å°†ç¼–å†™ä¸€ä¸ªæ”¯æŒä½œä¸šæ§åˆ¶çš„ç®€å• Unix shell ç¨‹åºã€‚

### äºŒ å®éªŒè¦æ±‚

æŸ¥çœ‹ `tsh.c`ï¼ˆtiny shellï¼‰æ–‡ä»¶ï¼Œä½ ä¼šå‘ç°å®ƒåŒ…å«äº†ä¸€ä¸ªç®€å• Unix shell çš„åŠŸèƒ½æ¡†æ¶ã€‚ä¸ºäº†å¸®åŠ©ä½ å…¥é—¨ï¼Œæˆ‘ä»¬å·²ç»å®ç°äº†ä¸€äº›ä¸å¤ªæœ‰è¶£çš„å‡½æ•°ã€‚ä½ çš„ä»»åŠ¡æ˜¯å®Œæˆä¸‹é¢åˆ—å‡ºçš„å…¶ä½™ç©ºå‡½æ•°ã€‚æˆ‘ä»¬åœ¨å‚è€ƒè§£å†³æ–¹æ¡ˆï¼ˆåŒ…æ‹¬å¤§é‡æ³¨é‡Šï¼‰ä¸­åˆ—å‡ºäº†æ¯ä¸ªå‡½æ•°çš„å¤§è‡´ä»£ç è¡Œæ•°ï¼Œä½œä¸ºå¯¹ä½ çš„åˆç†æ€§çš„æ£€æŸ¥ã€‚

- `eval`ï¼š è§£æå’Œè§£é‡Šå‘½ä»¤è¡Œçš„ä¸»è¦ä¾‹ç¨‹ã€‚[70è¡Œï¼½
- `builtin cmd`ï¼š è¯†åˆ«å¹¶è§£é‡Šå†…ç½®å‘½ä»¤ï¼šquitã€fgã€bg å’Œ jobsã€‚[25è¡Œï¼½
- `do bgfg`: æ‰§è¡Œ bg å’Œ fg å†…ç½®å‘½ä»¤ã€‚[50 è¡Œï¼½
- `waitfg`ï¼šç­‰å¾…å‰å°ä½œä¸šå®Œæˆã€‚[20 è¡Œï¼½
- `sigchld handler`ï¼š æ•æ‰ SIGCHILD ä¿¡å·ã€‚80 è¡Œï¼½
- `sigint_handler`ï¼šæ•è· SIGINTï¼ˆctrl-cï¼‰ä¿¡å·ã€‚[15 è¡Œï¼½
- `sigtstp_handler`ï¼š æ•æ‰ SIGTSTP (ctrl-z) ä¿¡å·ã€‚[15 è¡Œï¼½

### ä¸‰ å®éªŒç¯å¢ƒ

- Vs Codeã€Githubã€Typoraï¼›
- ä¹¦ï¼šã€Šæ·±å…¥ç†è§£è®¡ç®—æœºç³»ç»Ÿã€‹
- ç½‘ç«™ï¼š
https://wdxtub.com/csapp/thick-csapp-lab-5/2016/04/16/
https://www.jianshu.com/p/7f5e78e83a0e

### å›› å‰ç½®çŸ¥è¯†

#### signalä¿¡å·å¤„ç†

åœ¨ç»ˆç«¯é‡Œè¾“å…¥ `man 7 signal`å‘½ä»¤ï¼Œ æŸ¥çœ‹ä¿¡å·çš„æ€»è§ˆã€‚

[![19b546bd72a06fce6c526dd478bd2c8d.png](https://s1.imagehub.cc/images/2023/11/19/19b546bd72a06fce6c526dd478bd2c8d.png)](https://www.imagehub.cc/image/1OPU5R)

å½“æˆ‘ä½¿ç”¨ `man 7 signal` æŸ¥çœ‹ä¿¡å·çš„æ‰‹å†Œæ—¶ï¼Œæˆ‘è·å¾—äº†æ·±å…¥äº†è§£ä¿¡å·å¤„ç†çš„ä¿¡æ¯ã€‚ä»¥ä¸‹æ˜¯æˆ‘å‘ç°å¯¹CSAPPçš„shell labå®éªŒå¯èƒ½æœ‰å¸®åŠ©çš„å…³é”®ç‚¹ï¼š

1. **ä¿¡å·åˆ—è¡¨ï¼š** æˆ‘äº†è§£åˆ°æœ‰å„ç§ä¸åŒçš„ä¿¡å·ï¼Œæ¯ä¸ªä¿¡å·éƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„æ ‡è¯†ç¬¦ï¼Œå¦‚`SIGHUP`ã€`SIGINT`ã€`SIGSEGV`ç­‰ã€‚è¿™äº›ä¿¡å·åœ¨Shellç¼–ç¨‹ä¸­æ˜¯éå¸¸é‡è¦çš„ï¼Œå› ä¸ºå®ƒä»¬ä¸è¿›ç¨‹çš„ä¸åŒçŠ¶æ€å’Œäº‹ä»¶ç›¸å…³è”ã€‚
2. **é»˜è®¤è¡Œä¸ºï¼š** å¯¹äºæ¯ä¸ªä¿¡å·ï¼Œæ‰‹å†Œè¯¦ç»†æè¿°äº†é»˜è®¤çš„ä¿¡å·å¤„ç†è¡Œä¸ºã€‚ä¾‹å¦‚ï¼Œ`SIGINT` çš„é»˜è®¤è¡Œä¸ºæ˜¯ç»ˆæ­¢è¿›ç¨‹ã€‚è¿™å¯¹äºæˆ‘ç†è§£åœ¨ä¸åŒæƒ…å†µä¸‹å‘ç”Ÿä¿¡å·æ—¶ç³»ç»Ÿçš„é»˜è®¤è¡Œä¸ºå¾ˆæœ‰å¸®åŠ©ã€‚
3. **ä¿¡å·å¤„ç†å‡½æ•°ï¼š** æ‰‹å†Œä»‹ç»äº†å¦‚ä½•è®¾ç½®ä¿¡å·å¤„ç†å‡½æ•°ï¼Œè¿™å¯¹äºåœ¨Shellä¸­å¤„ç†å¼‚æ­¥ä¿¡å·æ˜¯è‡³å…³é‡è¦çš„ã€‚æˆ‘å­¦åˆ°äº†å¯ä»¥ä½¿ç”¨ `signal` å‡½æ•°æˆ–æ›´ä¸ºçµæ´»çš„ `sigaction` å‡½æ•°æ¥æ³¨å†Œä¿¡å·å¤„ç†å‡½æ•°ã€‚
4. **ä¿¡å·çš„äº§ç”Ÿå’Œä¼ é€’ï¼š** æ‰‹å†Œè§£é‡Šäº†ä¿¡å·æ˜¯å¦‚ä½•äº§ç”Ÿå’Œä¼ é€’çš„ï¼Œè¿™æœ‰åŠ©äºæˆ‘ç†è§£åœ¨ä¸åŒæƒ…å†µä¸‹ä½•æ—¶ä¼šå‘ç”Ÿä¿¡å·ã€‚è¿™å¯¹äºæ­£ç¡®åœ°è®¾è®¡Shellç¨‹åºä»¥å¤„ç†å¼‚æ­¥äº‹ä»¶éå¸¸å…³é”®ã€‚
5. **å¯é ä¿¡å·å¤„ç†ï¼š** æˆ‘äº†è§£åˆ°ä¸€äº›ä¿¡å·å¯ä»¥è¢«è®¾ç½®ä¸ºâ€œå¯é â€å¤„ç†ï¼Œè¿™æ„å‘³ç€å¦‚æœåœ¨ä¿¡å·å¤„ç†å‡½æ•°æ‰§è¡ŒæœŸé—´å†æ¬¡å‘ç”Ÿè¯¥ä¿¡å·ï¼Œç³»ç»Ÿä¼šç­‰å¾…å¤„ç†å‡½æ•°å®Œæˆåå†è°ƒç”¨å¤„ç†å‡½æ•°ã€‚è¿™å¯¹äºç¡®ä¿ä¿¡å·å¤„ç†çš„å¯é æ€§å’Œä¸€è‡´æ€§å¾ˆé‡è¦ã€‚

#### waitpidå‡½æ•°

ä½¿ç”¨`man waitpid`æŸ¥çœ‹`wait`çš„æ‰‹å†Œæ—¶ï¼Œæ˜ å…¥çœ¼å¸˜çš„å°±æ˜¯`wait,waitpid,waitid`çš„å®šä¹‰ï¼š`wait for process to change state`ï¼Œå³ `ç­‰å¾…è¿›ç¨‹æ”¹å˜çŠ¶æ€`ã€‚åœ¨è¿™é‡Œï¼Œâ€œçŠ¶æ€â€æŒ‡çš„æ˜¯è¿›ç¨‹å¯èƒ½å¤„äºçš„å‡ ç§çŠ¶æ€ï¼ŒåŒ…æ‹¬ `terminated`ï¼ˆç»“æŸï¼‰å’Œ `stopped`ï¼ˆç»ˆæ­¢ï¼‰ã€‚
[![74535a8514975cb39a40e0974681e5e6.png](https://s1.imagehub.cc/images/2023/11/19/74535a8514975cb39a40e0974681e5e6.png)](https://www.imagehub.cc/image/1Os2gT)
å…·ä½“è€Œè¨€ï¼Œæˆ‘æ‰¾åˆ°äº† `waitpid` å‡½æ•°çš„åŸå‹ï¼š

```c
pid_t waitpid(pid_t pid, int *wstatus, int options);
```

è¿™ä¸ªå‡½æ•°çš„ç›®çš„æ˜¯ç­‰å¾…ç‰¹å®šè¿›ç¨‹çš„çŠ¶æ€å‘ç”Ÿå˜åŒ–ã€‚å…¶ä¸­å‚æ•°çš„å«ä¹‰å¦‚ä¸‹ï¼š

- `pid`ï¼šè¦ç­‰å¾…çš„è¿›ç¨‹çš„è¿›ç¨‹IDï¼Œå¦‚æœä¸ºè´Ÿå€¼ï¼Œåˆ™ç­‰å¾…ä»»ä½•å­è¿›ç¨‹çš„çŠ¶æ€å‘ç”Ÿå˜åŒ–ã€‚
- `wstatus`ï¼šç”¨äºå­˜å‚¨å­è¿›ç¨‹çš„é€€å‡ºçŠ¶æ€æˆ–ç»ˆæ­¢ä¿¡å·çš„æ•´æ•°æŒ‡é’ˆã€‚
- `options`ï¼šç”¨äºæŒ‡å®šç­‰å¾…çš„è¡Œä¸ºï¼Œä¾‹å¦‚æ˜¯å¦é˜»å¡ç­‰ã€‚

é€šè¿‡è°ƒç”¨ `waitpid`ï¼Œå¯ä»¥ä½¿å½“å‰è¿›ç¨‹æš‚åœæ‰§è¡Œï¼Œç›´åˆ°æŒ‡å®šçš„å­è¿›ç¨‹æ”¹å˜å…¶çŠ¶æ€ã€‚è¿™åœ¨å¤„ç†å­è¿›ç¨‹çš„é€€å‡ºçŠ¶æ€æ—¶æ˜¯éå¸¸æœ‰ç”¨çš„ï¼Œç‰¹åˆ«æ˜¯åœ¨ç¼–å†™Shellæˆ–ç±»ä¼¼çš„è¿›ç¨‹æ§åˆ¶ç¨‹åºæ—¶ã€‚

#### killå‡½æ•°

[![26369db6b06ecf83016bd22dc99496e7.png](https://s1.imagehub.cc/images/2023/11/19/26369db6b06ecf83016bd22dc99496e7.png)](https://www.imagehub.cc/image/1OsE37)

ä½¿ç”¨`man kill`æŸ¥çœ‹`kill`çš„æ‰‹å†Œæ—¶ï¼Œå¯ä»¥çœ‹åˆ°ï¼š`kill`çš„å®šä¹‰ä¸º`send a signal to a process`ï¼Œå³`å‘é€ä¸€ä¸ªä¿¡å·çµ¦è¿›ç¨‹`ã€‚å¹¶ä¸æ˜¯å­—é¢æ„ä¹‰ä¸Šçš„`æ€æ­»æŸä¸ªè¿›ç¨‹`ã€‚`kill`å‘è¿›ç¨‹å‘é€çš„é»˜è®¤ä¿¡å·æ˜¯`TERM`ï¼Œå°±æ˜¯ç»“æŸæŸä¸ªè¿›ç¨‹ï¼Œä½†å®ƒä¹Ÿå¯ä»¥å‘é€åˆ«çš„ä¿¡å·ï¼Œä¾‹å¦‚`HUP, INT, KILL, STOP, CONT, and 0`ã€‚

#### sigprocmaskå‡½æ•°

[![7fdca3ad846279db74ff4bb53accca7d.png](https://s1.imagehub.cc/images/2023/11/19/7fdca3ad846279db74ff4bb53accca7d.png)](https://www.imagehub.cc/image/1OsZKR)

é€šè¿‡æŸ¥çœ‹ `sigprocmask` å‡½æ•°çš„æ‰‹å†Œï¼Œæˆ‘å¯ä»¥çœ‹åˆ°ï¼Œè¿™ä¸ªå‡½æ•°æ˜¯ç”¨äº`æ£€æŸ¥å¹¶æ”¹å˜è¢«é˜»å¡çš„ä¿¡å·çš„`ã€‚`sigprocmask` å‡½æ•°çš„åŸå‹å¦‚ä¸‹ï¼š

```c
int sigprocmask(int how, const sigset_t *set, sigset_t *oldset);
```

å…¶ä¸­ï¼Œç¬¬ä¸€ä¸ªå‚æ•° `how` å¯ä»¥å–ä»¥ä¸‹å‡ ç§å€¼ï¼š

- `SIG_BLOCK`ï¼šå°†æŒ‡å®šçš„ä¿¡å·é›†æ·»åŠ åˆ°å½“å‰çš„ä¿¡å·å±è”½å­—ï¼ˆè¢«é˜»å¡çš„ä¿¡å·é›†ï¼‰ä¸­ã€‚
- `SIG_UNBLOCK`ï¼šä»å½“å‰çš„ä¿¡å·å±è”½å­—ä¸­ç§»é™¤æŒ‡å®šçš„ä¿¡å·é›†ã€‚
- `SIG_SETMASK`ï¼šå°†å½“å‰çš„ä¿¡å·å±è”½å­—è®¾ç½®ä¸ºæŒ‡å®šçš„ä¿¡å·é›†ã€‚

è¿™ä¸ªå‡½æ•°çš„ä½œç”¨æ˜¯åœ¨è¿›ç¨‹ä¸­ç®¡ç†ä¿¡å·çš„é˜»å¡çŠ¶æ€ã€‚é€šè¿‡è°ƒç”¨ `sigprocmask`ï¼Œå¯ä»¥æ§åˆ¶å“ªäº›ä¿¡å·åœ¨è¿›ç¨‹æ‰§è¡ŒæœŸé—´è¢«é˜»å¡ï¼Œä»¥åŠå“ªäº›ä¿¡å·ä¸è¢«é˜»å¡ã€‚

æ­¤å¤–ï¼Œå‡½æ•°çš„ç¬¬äºŒä¸ªå‚æ•° `set` æ˜¯ä¸€ä¸ªæŒ‡å‘è¦æ“ä½œçš„ä¿¡å·é›†çš„æŒ‡é’ˆï¼Œè€Œç¬¬ä¸‰ä¸ªå‚æ•° `oldset` åˆ™æ˜¯ä¸€ä¸ªæŒ‡å‘ä¿å­˜ä¹‹å‰ä¿¡å·å±è”½å­—çš„æŒ‡é’ˆã€‚é€šè¿‡ä¼ é€’è¿™ä¸¤ä¸ªå‚æ•°ï¼Œå¯ä»¥è·å–æˆ–ä¿®æ”¹å½“å‰çš„ä¿¡å·å±è”½å­—ï¼Œä»è€Œå®ç°å¯¹ä¿¡å·çš„çµæ´»ç®¡ç†ã€‚

è¿™å¯¹äºéœ€è¦ç²¾ç»†æ§åˆ¶ä¿¡å·å¤„ç†çš„åœºæ™¯ï¼Œæ¯”å¦‚åœ¨ä¿¡å·å¤„ç†ç¨‹åºæ‰§è¡ŒæœŸé—´é˜»å¡æŸäº›ä¿¡å·ä»¥é¿å…ä¸­æ–­ï¼Œæ˜¯éå¸¸æœ‰ç”¨çš„ã€‚





### äº” å®éªŒå†…å®¹

#### 1  sigint_handler

- ä»»åŠ¡æè¿°

  `sigint_handler`ï¼šæ•è· SIGINTï¼ˆctrl-cï¼‰ä¿¡å·ã€‚[15 è¡Œï¼½

- å®ç°æ–¹æ³•

  1. **è·å–å‰å°ä½œä¸šçš„è¿›ç¨‹IDï¼š** ä½¿ç”¨ `fgpid` å‡½æ•°è·å–å½“å‰å‰å°ä½œä¸šçš„è¿›ç¨‹IDã€‚
  2. **æ£€æŸ¥è¿›ç¨‹IDçš„æœ‰æ•ˆæ€§ï¼š** æ£€æŸ¥è·å–çš„è¿›ç¨‹IDæ˜¯å¦æœ‰æ•ˆï¼ˆéé›¶ï¼‰ã€‚å¦‚æœä¸ºé›¶ï¼Œè¡¨ç¤ºæ²¡æœ‰å‰å°ä½œä¸šéœ€è¦å¤„ç†ï¼Œç›´æ¥è¿”å›ã€‚
  3. **å‘è¿›ç¨‹ç»„å‘é€SIGINTä¿¡å·ï¼š** ä½¿ç”¨ `kill` å‡½æ•°å‘å…·æœ‰ç»™å®šè¿›ç¨‹IDçš„è¿›ç¨‹ç»„å‘é€ `SIGINT` ä¿¡å·ã€‚è¿™é‡Œä½¿ç”¨è´Ÿå· `-` æ¥å°†ä¿¡å·å‘é€ç»™æ•´ä¸ªè¿›ç¨‹ç»„ï¼Œä»¥ç»ˆæ­¢å‰å°ä½œä¸šä¸­çš„æ‰€æœ‰è¿›ç¨‹ã€‚
  4. **è¿”å›ï¼š** ä»ä¿¡å·å¤„ç†ç¨‹åºè¿”å›ã€‚

  ```c
  void sigint_handler(int sig)
  {
      // ä½¿ç”¨'fgpid'å‡½æ•°è·å–å‰å°ä½œä¸šçš„è¿›ç¨‹ID
      pid_t pid = fgpid(jobs);
  
      // æ£€æŸ¥è·å–çš„è¿›ç¨‹IDæ˜¯å¦æœ‰æ•ˆï¼ˆä¸ç­‰äº0ï¼‰
      if (pid != 0)
      {
          // å‘å…·æœ‰ç»™å®šè¿›ç¨‹IDçš„è¿›ç¨‹ç»„å‘é€SIGINTä¿¡å·
          // ä½¿ç”¨è´Ÿå·ï¼ˆ-ï¼‰å‘é€ä¿¡å·åˆ°æ•´ä¸ªè¿›ç¨‹ç»„
          // è¿™æ˜¯ä¸ºäº†ç»ˆæ­¢å‰å°ä½œä¸šä¸­çš„æ‰€æœ‰è¿›ç¨‹
          kill(-pid, sig);
      }
  
      // ä»ä¿¡å·å¤„ç†ç¨‹åºè¿”å›
      return;
  }
  ```

æ•´ä¸ªæ€è·¯å°±æ˜¯é€šè¿‡è·å–å‰å°ä½œä¸šçš„è¿›ç¨‹IDï¼Œç„¶åå‘è¯¥è¿›ç¨‹IDæ‰€åœ¨çš„è¿›ç¨‹ç»„å‘é€ `SIGINT` ä¿¡å·ï¼Œä»è€Œå®ç°ç»ˆæ­¢å‰å°ä½œä¸šä¸­çš„æ‰€æœ‰è¿›ç¨‹ã€‚è¿™æ ·ï¼Œå½“ç”¨æˆ·æŒ‰ä¸‹ `Ctrl+C` æ—¶ï¼Œä¼šè§¦å‘ `SIGINT` ä¿¡å·ï¼Œè¿›è€Œè°ƒç”¨è¯¥å¤„ç†å‡½æ•°ï¼Œç»ˆæ­¢å‰å°ä½œä¸šä¸­çš„æ‰€æœ‰ç›¸å…³è¿›ç¨‹ã€‚

#### 2  sigtstp_handler

- ä»»åŠ¡æè¿°

  `sigtstp_handler`ï¼š æ•æ‰ SIGTSTP (ctrl-z) ä¿¡å·ã€‚[15 è¡Œï¼½

- å®ç°æ–¹æ³•

  1. **è·å–å‰å°ä½œä¸šçš„è¿›ç¨‹IDï¼š** ä½¿ç”¨ `fgpid` å‡½æ•°è·å–å½“å‰å‰å°ä½œä¸šçš„è¿›ç¨‹IDã€‚
  2. **æ£€æŸ¥è¿›ç¨‹IDçš„æœ‰æ•ˆæ€§ï¼š** æ£€æŸ¥è·å–çš„è¿›ç¨‹IDæ˜¯å¦æœ‰æ•ˆï¼ˆéé›¶ï¼‰ã€‚å¦‚æœä¸ºé›¶ï¼Œè¡¨ç¤ºæ²¡æœ‰å‰å°ä½œä¸šéœ€è¦å¤„ç†ï¼Œç›´æ¥è¿”å›ã€‚
  3. **å‘è¿›ç¨‹ç»„å‘é€SIGTSTPä¿¡å·ï¼š** ä½¿ç”¨ `kill` å‡½æ•°å‘å…·æœ‰ç»™å®šè¿›ç¨‹IDçš„è¿›ç¨‹ç»„å‘é€ `SIGTSTP` ä¿¡å·ã€‚è¿™é‡Œä½¿ç”¨è´Ÿå· `-` æ¥å°†ä¿¡å·å‘é€ç»™æ•´ä¸ªè¿›ç¨‹ç»„ï¼Œä»¥åœæ­¢å‰å°ä½œä¸šä¸­çš„æ‰€æœ‰è¿›ç¨‹ã€‚
  4. **è¿”å›ï¼š** ä»ä¿¡å·å¤„ç†ç¨‹åºè¿”å›ã€‚

  ```c
  void sigtstp_handler(int sig)
  {
      // ä½¿ç”¨'fgpid'å‡½æ•°è·å–å‰å°ä½œä¸šçš„è¿›ç¨‹ID
      pid_t pid = fgpid(jobs);
  
      // æ£€æŸ¥è·å–çš„è¿›ç¨‹IDæ˜¯å¦æœ‰æ•ˆï¼ˆä¸ç­‰äº0ï¼‰
      if (pid != 0)
      {
          // å‘å…·æœ‰ç»™å®šè¿›ç¨‹IDçš„è¿›ç¨‹ç»„å‘é€SIGTSTPä¿¡å·
          // ä½¿ç”¨è´Ÿå·ï¼ˆ-ï¼‰å‘é€ä¿¡å·åˆ°æ•´ä¸ªè¿›ç¨‹ç»„
          // è¿™æ˜¯ä¸ºäº†åœæ­¢å‰å°ä½œä¸šä¸­çš„æ‰€æœ‰è¿›ç¨‹
          kill(-pid, sig);
      }
  
      // ä»ä¿¡å·å¤„ç†ç¨‹åºè¿”å›
      return;
  }
  ```

æ•´ä¸ªæ€è·¯å°±æ˜¯é€šè¿‡è·å–å‰å°ä½œä¸šçš„è¿›ç¨‹IDï¼Œç„¶åå‘è¯¥è¿›ç¨‹IDæ‰€åœ¨çš„è¿›ç¨‹ç»„å‘é€ `SIGTSTP` ä¿¡å·ï¼Œä»è€Œå®ç°åœæ­¢å‰å°ä½œä¸šä¸­çš„æ‰€æœ‰è¿›ç¨‹ã€‚è¿™æ ·ï¼Œå½“ç”¨æˆ·æŒ‰ä¸‹ `Ctrl+Z` æ—¶ï¼Œä¼šè§¦å‘ `SIGTSTP` ä¿¡å·ï¼Œè¿›è€Œè°ƒç”¨è¯¥å¤„ç†å‡½æ•°ï¼Œåœæ­¢å‰å°ä½œä¸šä¸­çš„æ‰€æœ‰ç›¸å…³è¿›ç¨‹ã€‚

#### 3  sigchld_handler

- ä»»åŠ¡æè¿°

  `sigchld handler`ï¼š æ•æ‰ SIGCHILD ä¿¡å·ã€‚80 è¡Œï¼½

- å®ç°æ–¹æ³•

  1. **å¾ªç¯ç­‰å¾…æ‰€æœ‰å­è¿›ç¨‹çš„çŠ¶æ€å˜åŒ–ï¼š** ä½¿ç”¨ `waitpid` å‡½æ•°ä»¥éé˜»å¡çš„æ–¹å¼å¾ªç¯ç­‰å¾…æ‰€æœ‰å­è¿›ç¨‹çš„çŠ¶æ€å˜åŒ–ã€‚`fgpid(jobs)` ç”¨äºè·å–å‰å°ä½œä¸šçš„è¿›ç¨‹IDã€‚
  2. **å¤„ç†è¢«æš‚åœçš„å­è¿›ç¨‹ï¼š** å¦‚æœå­è¿›ç¨‹è¢«æš‚åœï¼ˆ`WIFSTOPPED(status)`ä¸ºçœŸï¼‰ï¼Œåˆ™ä¿®æ”¹ç›¸åº”ä½œä¸šçš„çŠ¶æ€ä¸ºåœæ­¢ï¼ˆ`ST`ï¼‰ã€‚ç„¶åï¼Œè·å–ä½œä¸šIDï¼Œå¹¶æ‰“å°ç›¸å…³ä¿¡æ¯ï¼ŒåŒ…æ‹¬ä½œä¸šIDã€è¿›ç¨‹IDå’Œå¯¼è‡´åœæ­¢çš„ä¿¡å·ã€‚
  3. **å¤„ç†è¢«ä¿¡å·ç»ˆæ­¢çš„å­è¿›ç¨‹ï¼š** å¦‚æœå­è¿›ç¨‹è¢«ä¿¡å·ç»ˆæ­¢ï¼ˆ`WIFSIGNALED(status)`ä¸ºçœŸï¼‰ï¼Œåˆ™è·å–ä½œä¸šIDï¼Œå¹¶æ‰“å°ç›¸å…³ä¿¡æ¯ï¼ŒåŒ…æ‹¬ä½œä¸šIDã€è¿›ç¨‹IDå’Œå¯¼è‡´ç»ˆæ­¢çš„ä¿¡å·ã€‚ç„¶åï¼Œä½¿ç”¨ `deletejob` å‡½æ•°åˆ é™¤è¯¥ä½œä¸šã€‚
  4. **å¤„ç†æ­£å¸¸é€€å‡ºçš„å­è¿›ç¨‹ï¼š** å¦‚æœå­è¿›ç¨‹æ­£å¸¸é€€å‡ºï¼ˆ`WIFEXITED(status)`ä¸ºçœŸï¼‰ï¼Œåˆ™ä½¿ç”¨ `deletejob` å‡½æ•°åˆ é™¤è¯¥ä½œä¸šã€‚
  5. **å¾ªç¯ç›´åˆ°æ²¡æœ‰å­è¿›ç¨‹çŠ¶æ€éœ€è¦å¤„ç†ï¼š** ç»§ç»­å¾ªç¯ï¼Œç›´åˆ° `waitpid` ä¸å†è¿”å›ä»»ä½•å­è¿›ç¨‹çŠ¶æ€ã€‚è¿™æ˜¯é€šè¿‡æ£€æŸ¥ `pid > 0` æ¡ä»¶æ¥å®ç°çš„ã€‚
  6. **è¿”å›ï¼š** ä»ä¿¡å·å¤„ç†ç¨‹åºè¿”å›

  ```c
  void sigchld_handler(int sig)
  {
      int status;
      pid_t pid;
  
      // å¾ªç¯ç­‰å¾…æ‰€æœ‰å­è¿›ç¨‹çš„çŠ¶æ€å˜åŒ–
      while ((pid = waitpid(fgpid(jobs), &status, WNOHANG | WUNTRACED)) > 0)
      {
          if (WIFSTOPPED(status))
          {
              // å¦‚æœå­è¿›ç¨‹è¢«æš‚åœï¼Œåˆ™ä¿®æ”¹ä½œä¸šçŠ¶æ€ä¸ºåœæ­¢
              getjobpid(jobs, pid)->state = ST;
  
              // è·å–ä½œä¸šIDå¹¶æ‰“å°ç›¸å…³ä¿¡æ¯
              int jid = pid2jid(pid);
              printf("Job [%d] (%d) Stopped by signal %d\n", jid, pid, WSTOPSIG(status));
          }
          else if (WIFSIGNALED(status))
          {
              // å¦‚æœå­è¿›ç¨‹è¢«ä¿¡å·ç»ˆæ­¢ï¼Œåˆ™åˆ é™¤ä½œä¸š
              int jid = pid2jid(pid);
              printf("Job [%d] (%d) terminated by signal %d\n", jid, pid, WTERMSIG(status));
              deletejob(jobs, pid);
          }
          else if (WIFEXITED(status))
          {
              // å¦‚æœå­è¿›ç¨‹æ­£å¸¸é€€å‡ºï¼Œåˆ™åˆ é™¤ä½œä¸š
              deletejob(jobs, pid);
          }
      }
  
      // ä»ä¿¡å·å¤„ç†ç¨‹åºè¿”å›
      return;
  }
  ```

æ•´ä½“æ€è·¯æ˜¯é€šè¿‡å¾ªç¯ç­‰å¾…æ‰€æœ‰å­è¿›ç¨‹çš„çŠ¶æ€å˜åŒ–ï¼Œå¹¶æ ¹æ®ä¸åŒçš„çŠ¶æ€è¿›è¡Œç›¸åº”çš„å¤„ç†ã€‚å¦‚æœå­è¿›ç¨‹è¢«æš‚åœï¼Œä¿®æ”¹ä½œä¸šçŠ¶æ€å¹¶æ‰“å°ç›¸å…³ä¿¡æ¯ï¼›å¦‚æœå­è¿›ç¨‹è¢«ä¿¡å·ç»ˆæ­¢ï¼Œæ‰“å°ç›¸å…³ä¿¡æ¯å¹¶åˆ é™¤ä½œä¸šï¼›å¦‚æœå­è¿›ç¨‹æ­£å¸¸é€€å‡ºï¼Œç›´æ¥åˆ é™¤ä½œä¸šã€‚æœ€åï¼Œå¾ªç¯ç›´åˆ°æ²¡æœ‰å­è¿›ç¨‹çŠ¶æ€éœ€è¦å¤„ç†ã€‚

#### 4  waitfg

- ä»»åŠ¡æè¿°

  `waitfg`ï¼šç­‰å¾…å‰å°ä½œä¸šå®Œæˆã€‚[20 è¡Œï¼½

- å®ç°æ–¹æ³•

  1. **è·å–å…·æœ‰ç»™å®šè¿›ç¨‹IDçš„ä½œä¸šä¿¡æ¯ï¼š** ä½¿ç”¨ `getjobpid` å‡½æ•°è·å–å…·æœ‰ç»™å®šè¿›ç¨‹IDçš„ä½œä¸šä¿¡æ¯ã€‚
  2. **æ£€æŸ¥è¿›ç¨‹IDçš„æœ‰æ•ˆæ€§ï¼š** æ£€æŸ¥è·å–çš„è¿›ç¨‹IDæ˜¯å¦æœ‰æ•ˆï¼ˆéé›¶ï¼‰ã€‚å¦‚æœä¸ºé›¶ï¼Œè¡¨ç¤ºæ²¡æœ‰å‰å°ä½œä¸šéœ€è¦ç­‰å¾…ï¼Œç›´æ¥è¿”å›ã€‚
  3. **ç­‰å¾…å‰å°ä½œä¸šç»“æŸï¼š** è¿›å…¥ä¸€ä¸ªå¾ªç¯ï¼ŒæŒç»­æ£€æŸ¥å‰å°ä½œä¸šçš„è¿›ç¨‹IDæ˜¯å¦ä»ç„¶ç­‰äºç»™å®šçš„è¿›ç¨‹IDã€‚è¿™æ˜¯é€šè¿‡ä½¿ç”¨ `fgpid(jobs)` å‡½æ•°æ¥è·å–å½“å‰å‰å°ä½œä¸šçš„è¿›ç¨‹IDï¼Œå¹¶ä¸ä¼ å…¥çš„è¿›ç¨‹IDè¿›è¡Œæ¯”è¾ƒã€‚
  4. **è¿”å›ï¼š** ä¸€æ—¦å‰å°ä½œä¸šçš„è¿›ç¨‹IDä¸å†ç­‰äºç»™å®šçš„è¿›ç¨‹IDï¼Œè·³å‡ºå¾ªç¯ï¼Œä»å‡½æ•°è¿”å›ã€‚

  ```c
  void waitfg(pid_t pid)
  {
      struct job_t *job;
  
      // è·å–å…·æœ‰ç»™å®šè¿›ç¨‹IDçš„ä½œä¸šä¿¡æ¯
      job = getjobpid(jobs, pid);
  
      // æ£€æŸ¥è¿›ç¨‹IDæ˜¯å¦æœ‰æ•ˆ
      if (pid == 0)
      {
          return;
      }
  
      // å¦‚æœä½œä¸šä¿¡æ¯å­˜åœ¨
      if (job != NULL)
      {
          // ç­‰å¾…å‰å°ä½œä¸šç»“æŸ
          while (pid == fgpid(jobs))
          {
              // ç©ºå¾ªç¯ï¼Œç­‰å¾…å‰å°ä½œä¸šç»“æŸ
              // æ­¤å¾ªç¯é€šè¿‡æŒç»­æ£€æŸ¥å‰å°ä½œä¸šçš„è¿›ç¨‹IDæ˜¯å¦ä»ç„¶ç­‰äºç»™å®šçš„è¿›ç¨‹IDæ¥ç­‰å¾…ä½œä¸šç»“æŸ
          }
      }
  
      // ä»å‡½æ•°è¿”å›
      return;
  }
  ```

æ•´ä¸ªå®ç°æ€è·¯å°±æ˜¯é€šè¿‡ä¸æ–­æ£€æŸ¥å‰å°ä½œä¸šçš„è¿›ç¨‹IDæ˜¯å¦ä»ç„¶ç­‰äºç»™å®šçš„è¿›ç¨‹IDï¼Œç›´åˆ°å‰å°ä½œä¸šç»“æŸã€‚è¿™æ ·ï¼Œå½“ `waitfg` è¢«è°ƒç”¨æ—¶ï¼Œå®ƒä¼šä¸€ç›´ç­‰å¾…å‰å°ä½œä¸šç»“æŸåæ‰è¿”å›ã€‚è¿™é€šå¸¸ç”¨äºç¡®ä¿ shell åœ¨å‰å°ä½œä¸šæ‰§è¡Œå®Œæ¯•ä¹‹å‰ä¸ä¼šç»§ç»­æ‰§è¡Œå…¶ä»–å‘½ä»¤ã€‚

#### 5  builtin_cmd

- ä»»åŠ¡æè¿°

  `builtin cmd`ï¼š è¯†åˆ«å¹¶è§£é‡Šå†…ç½®å‘½ä»¤ï¼šquitã€fgã€bg å’Œ jobsã€‚[25è¡Œï¼½

- å®ç°æ–¹æ³•

  1. **"quit" å‘½ä»¤ï¼š** å¦‚æœè¾“å…¥çš„å‘½ä»¤æ˜¯ "quit"ï¼Œåˆ™è°ƒç”¨ `exit(0)` æ¥é€€å‡º shellã€‚
  2. **åå°æ‰§è¡Œå‘½ä»¤åˆ¤æ–­ï¼š** å¦‚æœå‘½ä»¤ä»¥ "&" ç»“å°¾ï¼Œè¡¨ç¤ºè¦åœ¨åå°æ‰§è¡Œã€‚åœ¨ shell ä¸­ï¼Œ"&" é€šå¸¸ç”¨äºè¡¨ç¤ºåå°æ‰§è¡Œã€‚è¿”å› 1ï¼Œè¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªåå°æ‰§è¡Œçš„å‘½ä»¤ã€‚
  3. **"jobs" å‘½ä»¤ï¼š** å¦‚æœå‘½ä»¤æ˜¯ "jobs"ï¼Œè°ƒç”¨ `listjobs` å‡½æ•°åˆ—å‡ºå½“å‰è¿è¡Œçš„ä½œä¸šä¿¡æ¯ã€‚ç„¶åè¿”å› 1ï¼Œè¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ª "jobs" å‘½ä»¤ã€‚
  4. **"bg" æˆ– "fg" å‘½ä»¤ï¼š** å¦‚æœå‘½ä»¤æ˜¯ "bg" æˆ– "fg"ï¼Œè°ƒç”¨ `do_bgfg` å‡½æ•°è¿›è¡Œä½œä¸šæ§åˆ¶æ“ä½œã€‚è¿™ä¸¤ä¸ªå‘½ä»¤é€šå¸¸ç”¨äºå°†ä½œä¸šç§»è‡³åå°æˆ–å‰å°æ‰§è¡Œã€‚ç„¶åè¿”å› 1ï¼Œè¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ª "bg" æˆ– "fg" å‘½ä»¤ã€‚
  5. **å…¶ä»–å‘½ä»¤ï¼š** å¦‚æœå‘½ä»¤ä¸æ˜¯å†…ç½®å‘½ä»¤ï¼Œåˆ™è¿”å› 0ï¼Œè¡¨ç¤ºè¿™ä¸æ˜¯ä¸€ä¸ªå†…ç½®å‘½ä»¤ã€‚è¿™å°†æç¤º shell æ‰§è¡Œå¤–éƒ¨å‘½ä»¤çš„é€»è¾‘ã€‚

  ```c
  int builtin_cmd(char **argv)
  {
      // å¦‚æœå‘½ä»¤æ˜¯ "quit"ï¼Œé€€å‡º shell
      if (!strcmp(argv[0], "quit"))
      {
          exit(0);
      }
      // å¦‚æœå‘½ä»¤ä»¥ "&" ç»“å°¾ï¼Œè¡¨ç¤ºåå°æ‰§è¡Œï¼Œè¿”å› 1
      else if (!strcmp("&", argv[0]))
      {
          return 1;
      }
      // å¦‚æœå‘½ä»¤æ˜¯ "jobs"ï¼Œåˆ—å‡ºå½“å‰è¿è¡Œçš„ä½œä¸šä¿¡æ¯ï¼Œç„¶åè¿”å› 1
      else if (!strcmp("jobs", argv[0]))
      {
          listjobs(jobs);
          return 1;
      }
      // å¦‚æœå‘½ä»¤æ˜¯ "bg" æˆ– "fg"ï¼Œè°ƒç”¨ do_bgfg å‡½æ•°è¿›è¡Œä½œä¸šæ§åˆ¶æ“ä½œï¼Œç„¶åè¿”å› 1
      else if (!strcmp("bg", argv[0]) || !strcmp("fg", argv[0]))
      {
          // è°ƒç”¨ do_bgfg å‡½æ•°è¿›è¡Œä½œä¸šæ§åˆ¶æ“ä½œ
          do_bgfg(argv);
          return 1;
      }
  
      // å¦‚æœå‘½ä»¤ä¸æ˜¯å†…ç½®å‘½ä»¤ï¼Œè¿”å› 0
      return 0;
  }
  ```

è¿™ä¸ªå‡½æ•°çš„ç›®çš„æ˜¯åˆ¤æ–­è¾“å…¥çš„å‘½ä»¤æ˜¯å¦æ˜¯å†…ç½®å‘½ä»¤ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™æ‰§è¡Œç›¸åº”çš„æ“ä½œï¼Œå¹¶è¿”å›ä¸€ä¸ªæ ‡å¿—æ¥æŒ‡ç¤º shell åº”è¯¥å¦‚ä½•å¤„ç†è¯¥å‘½ä»¤ã€‚

#### 6  do_bgfg

- ä»»åŠ¡æè¿°

  `do bgfg`: æ‰§è¡Œ bg å’Œ fg å†…ç½®å‘½ä»¤ã€‚[50 è¡Œï¼½

- å®ç°æ–¹æ³•

  1. **è·å–å‚æ•°ï¼š** è·å– `bg` æˆ– `fg` å‘½ä»¤ä¸­çš„å‚æ•°ï¼Œå³ä½œä¸šå·ï¼ˆä»¥ "%" å¼€å¤´ï¼‰æˆ–è¿›ç¨‹å·ã€‚
  2. **å‚æ•°æœ‰æ•ˆæ€§æ£€æŸ¥ï¼š** æ£€æŸ¥å‚æ•°æ˜¯å¦å­˜åœ¨ã€‚å¦‚æœå‚æ•°ä¸å­˜åœ¨ï¼Œåˆ™è¾“å‡ºé”™è¯¯ä¿¡æ¯å¹¶è¿”å›ã€‚
  3. **ä½œä¸šå·å’Œè¿›ç¨‹å·çš„å¤„ç†ï¼š**
     - å¦‚æœå‚æ•°ä»¥ "%" å¼€å¤´ï¼Œè¡¨ç¤ºä¸ºä½œä¸šå·ï¼ˆjidï¼‰ã€‚ä½¿ç”¨ `getjobjid` å‡½æ•°è·å–æŒ‡å®šä½œä¸šçš„ä¿¡æ¯ï¼Œå¹¶è·å–ä½œä¸šçš„è¿›ç¨‹IDï¼ˆpidï¼‰ã€‚
     - å¦‚æœå‚æ•°ä¸ºæ•°å­—ï¼Œè¡¨ç¤ºä¸ºè¿›ç¨‹å·ï¼ˆpidï¼‰ã€‚ä½¿ç”¨ `getjobpid` å‡½æ•°è·å–æŒ‡å®šè¿›ç¨‹çš„ä½œä¸šä¿¡æ¯ã€‚
  4. **å‚æ•°æ ¼å¼æ£€æŸ¥ï¼š** æ£€æŸ¥å‚æ•°æ ¼å¼æ˜¯å¦æ­£ç¡®ã€‚å¦‚æœä¸æ­£ç¡®ï¼Œè¾“å‡ºé”™è¯¯ä¿¡æ¯å¹¶è¿”å›ã€‚
  5. **å‘é€ SIGCONT ä¿¡å·ï¼š** ä½¿ç”¨ `kill` å‡½æ•°å‘æŒ‡å®šè¿›ç¨‹ç»„å‘é€ `SIGCONT` ä¿¡å·ï¼Œä»¥æ¢å¤ä½œä¸šçš„æ‰§è¡Œã€‚
  6. **æ‰§è¡Œ fg å‘½ä»¤ï¼š** å¦‚æœæ˜¯ `fg` å‘½ä»¤ï¼Œå°†ä½œä¸šçŠ¶æ€è®¾ç½®ä¸ºå‰å°è¿è¡Œï¼ˆ`FG`ï¼‰ï¼Œç„¶åè°ƒç”¨ `waitfg` å‡½æ•°ç­‰å¾…å‰å°ä½œä¸šç»“æŸã€‚
  7. **æ‰§è¡Œ bg å‘½ä»¤ï¼š** å¦‚æœæ˜¯ `bg` å‘½ä»¤ï¼Œæ‰“å°åå°è¿è¡Œçš„ä½œä¸šä¿¡æ¯ï¼Œå¹¶å°†ä½œä¸šçŠ¶æ€è®¾ç½®ä¸ºåå°è¿è¡Œï¼ˆ`BG`ï¼‰ã€‚

  ```c
  void do_bgfg(char **argv)
  {
      struct job_t *job;
      char *tmp;
      int jid;
      pid_t pid;
  
      // è·å–å‘½ä»¤ä¸­çš„å‚æ•°
      tmp = argv[1];
  
      // å¦‚æœå‚æ•°ä¸å­˜åœ¨
      if(tmp == NULL) {
          printf("%s command requires PID or %%jobid argument\n", argv[0]);
          return;
      }
  
      // å¦‚æœæ˜¯ä½œä¸šå·ï¼ˆjidï¼‰
      if(tmp[0] == '%') {
          jid = atoi(&tmp[1]);
          // è·å–æŒ‡å®šä½œä¸š
          job = getjobjid(jobs, jid);
          // å¦‚æœä½œä¸šä¸å­˜åœ¨
          if(job == NULL){
              printf("%s: No such job\n", tmp);
              return;
          } else {
              // è·å–è¯¥ä½œä¸šçš„è¿›ç¨‹IDï¼Œä»¥å¤‡åç»­ä½¿ç”¨
              pid = job->pid;
          }
      }
      // å¦‚æœæ˜¯è¿›ç¨‹IDï¼ˆpidï¼‰
      else if(isdigit(tmp[0])) {
          // è·å–è¿›ç¨‹ID
          pid = atoi(tmp);
          // è·å–æŒ‡å®šè¿›ç¨‹çš„ä½œä¸šä¿¡æ¯
          job = getjobpid(jobs, pid);
          // å¦‚æœä½œä¸šä¸å­˜åœ¨
          if(job == NULL){
              printf("(%d): No such process\n", pid);
              return;
          }
      }
      // å¦‚æœå‚æ•°æ ¼å¼ä¸æ­£ç¡®
      else {
          printf("%s: argument must be a PID or %%jobid\n", argv[0]);
          return;
      }
  
      // å‘æŒ‡å®šè¿›ç¨‹ç»„å‘é€ SIGCONT ä¿¡å·ï¼Œä»¥æ¢å¤ä½œä¸šæ‰§è¡Œ
      if (kill(-pid, SIGCONT) < 0) {
          perror("kill");
          return;
      }
  
      // å¦‚æœæ˜¯ fg å‘½ä»¤
      if(!strcmp("fg", argv[0])) {
          // å°†ä½œä¸šçŠ¶æ€è®¾ç½®ä¸ºå‰å°è¿è¡Œ
          job->state = FG;
          // ç­‰å¾…å‰å°ä½œä¸šç»“æŸ
          waitfg(job->pid);
      }
      // å¦‚æœæ˜¯ bg å‘½ä»¤
      else {
          // æ‰“å°åå°è¿è¡Œçš„ä½œä¸šä¿¡æ¯
          printf("[%d] (%d) %s", job->jid, job->pid, job->cmdline);
          // å°†ä½œä¸šçŠ¶æ€è®¾ç½®ä¸ºåå°è¿è¡Œ
          job->state = BG;
      }
  }
  ```

#### 7  sigtstp_handler

- ä»»åŠ¡æè¿°

  `sigtstp_handler`ï¼š æ•æ‰ SIGTSTP (ctrl-z) ä¿¡å·ã€‚[15 è¡Œï¼½

- å®ç°æ–¹æ³•

  1. **å‚æ•°è§£æï¼š**
     ä½¿ç”¨ `parseline` å‡½æ•°è§£æå‘½ä»¤è¡Œï¼Œå¡«å…… `argv` æ•°ç»„ï¼Œå¹¶è¿”å›æ˜¯å¦åœ¨åå°è¿è¡Œçš„æ ‡å¿— `bg`ã€‚
  2. **å†…ç½®å‘½ä»¤å¤„ç†ï¼š**
     è°ƒç”¨ `builtin_cmd` å‡½æ•°æ£€æŸ¥å‘½ä»¤æ˜¯å¦æ˜¯å†…ç½®å‘½ä»¤ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™æ‰§è¡Œç›¸åº”çš„å†…ç½®å‘½ä»¤å¹¶è¿”å›ã€‚
  3. **ä¿¡å·é˜»å¡ï¼š**
     ä½¿ç”¨ `sigset_t` ç±»å‹çš„ä¿¡å·é›†åˆ `mask` é˜»å¡ `SIGCHLD` ä¿¡å·ï¼Œé˜²æ­¢åœ¨æ·»åŠ ä½œä¸šå‰å­è¿›ç¨‹å°±ç»ªå¯¼è‡´çš„ç«æ€æ¡ä»¶ã€‚
  4. **åˆ›å»ºå­è¿›ç¨‹ï¼š**
     ä½¿ç”¨ `fork` å‡½æ•°åˆ›å»ºä¸€ä¸ªæ–°çš„å­è¿›ç¨‹ã€‚
  5. **å­è¿›ç¨‹æ“ä½œï¼š**
     å¦‚æœæ˜¯å­è¿›ç¨‹ï¼Œè§£é™¤å¯¹ `SIGCHLD` ä¿¡å·çš„é˜»å¡ã€‚
     å°†å­è¿›ç¨‹è®¾ç½®ä¸ºæ–°çš„è¿›ç¨‹ç»„çš„ç»„é•¿ã€‚
     æ‰§è¡Œå‘½ä»¤ï¼Œå¦‚æœå¤±è´¥åˆ™è¾“å‡ºé”™è¯¯ä¿¡æ¯å¹¶é€€å‡ºã€‚
  6. **çˆ¶è¿›ç¨‹æ“ä½œï¼š**
     å¦‚æœæ˜¯çˆ¶è¿›ç¨‹ï¼Œæ·»åŠ ä½œä¸šåˆ°ä½œä¸šåˆ—è¡¨ã€‚
     è§£é™¤å¯¹ `SIGCHLD` ä¿¡å·çš„é˜»å¡ã€‚
     æ ¹æ®å‘½ä»¤åœ¨å‰å°è¿˜æ˜¯åå°è¿è¡Œï¼Œé‡‡å–ç›¸åº”çš„ç­‰å¾…æˆ–æ‰“å°æ“ä½œã€‚

  ```c
  void sigtstp_handler(int sig)
  {
      // ä½¿ç”¨'fgpid'å‡½æ•°è·å–å‰å°ä½œä¸šçš„è¿›ç¨‹ID
      pid_t pid = fgpid(jobs);
  
      // æ£€æŸ¥è·å–çš„è¿›ç¨‹IDæ˜¯å¦æœ‰æ•ˆï¼ˆä¸ç­‰äº0ï¼‰
      if (pid != 0)
      {
          // å‘å…·æœ‰ç»™å®šè¿›ç¨‹IDçš„è¿›ç¨‹ç»„å‘é€SIGTSTPä¿¡å·
          // ä½¿ç”¨è´Ÿå·ï¼ˆ-ï¼‰å‘é€ä¿¡å·åˆ°æ•´ä¸ªè¿›ç¨‹ç»„
          // è¿™æ˜¯ä¸ºäº†åœæ­¢å‰å°ä½œä¸šä¸­çš„æ‰€æœ‰è¿›ç¨‹
          kill(-pid, sig);
      }
  
      // ä»ä¿¡å·å¤„ç†ç¨‹åºè¿”å›
      return;
  }
  ```

#### æµ‹è¯•

- æµ‹è¯•ç»“æœ

  ***trace01***
  [![b825c1ee80671e3ea64b9955c573afbc.png](https://s1.imagehub.cc/images/2023/11/19/b825c1ee80671e3ea64b9955c573afbc.png)](https://www.imagehub.cc/image/1OEAph)
  ***trace02***
  [![f16bc81b38fa19055ea3db318a76d6ac.png](https://s1.imagehub.cc/images/2023/11/19/f16bc81b38fa19055ea3db318a76d6ac.png)](https://www.imagehub.cc/image/1OESbG)
  ***trace03***
  [![e10990d1373e2d6a1e3e17b55e705631.png](https://s1.imagehub.cc/images/2023/11/19/e10990d1373e2d6a1e3e17b55e705631.png)](https://www.imagehub.cc/image/1OEYEr)
  ***trace04***
  [![077619e7cd70e7433b3d558a5bcc505a.png](https://s1.imagehub.cc/images/2023/11/19/077619e7cd70e7433b3d558a5bcc505a.png)](https://www.imagehub.cc/image/1OGduv)
  ***trace05***
  [![cd21bd082e7e1b513e1a2a9d3e7c5789.png](https://s1.imagehub.cc/images/2023/11/19/cd21bd082e7e1b513e1a2a9d3e7c5789.png)](https://www.imagehub.cc/image/1OGfSt)
  ***trace06***
  [![e634b426e74a864b114b1e45944172fd.png](https://s1.imagehub.cc/images/2023/11/19/e634b426e74a864b114b1e45944172fd.png)](https://www.imagehub.cc/image/1OG1BS)
  ***trace07***
  [![738ffb13d69055e369e756f430271deb.png](https://s1.imagehub.cc/images/2023/11/19/738ffb13d69055e369e756f430271deb.png)](https://www.imagehub.cc/image/1OGbiL)
  ***trace08***
  [![36bf47f32ce6a2b4e379977c621a1770.png](https://s1.imagehub.cc/images/2023/11/19/36bf47f32ce6a2b4e379977c621a1770.png)](https://www.imagehub.cc/image/1OGC7B)
  ***trace09***
  [![77125fc7e8ad3162f19d3296cc0e9c24.png](https://s1.imagehub.cc/images/2023/11/19/77125fc7e8ad3162f19d3296cc0e9c24.png)](https://www.imagehub.cc/image/1OGMeq)
  ***trace10***
  [![29bb7ea22c3b32965f5173186a5f9f86.png](https://s1.imagehub.cc/images/2023/11/19/29bb7ea22c3b32965f5173186a5f9f86.png)](https://www.imagehub.cc/image/1OGgHU)
  ***trace11***
  [![4cc5304f8d1480c9065499fdbe1b4d80.png](https://s1.imagehub.cc/images/2023/11/19/4cc5304f8d1480c9065499fdbe1b4d80.png)](https://www.imagehub.cc/image/1OGwo0)
  ***trace12***
  [![c7e9eae5754830790317f5457beb7039.png](https://s1.imagehub.cc/images/2023/11/19/c7e9eae5754830790317f5457beb7039.png)](https://www.imagehub.cc/image/1OGlbz)
  ***trace13***
  [![a31ab78b46c774e7e0355160af746cd3.png](https://s1.imagehub.cc/images/2023/11/19/a31ab78b46c774e7e0355160af746cd3.png)](https://www.imagehub.cc/image/1OG0Ej)
  [![5d55b081d58439855a66fbdd73a61fb8.png](https://s1.imagehub.cc/images/2023/11/19/5d55b081d58439855a66fbdd73a61fb8.png)](https://www.imagehub.cc/image/1OG3vg)
  ***trace14***
  [![c64fdfe04fda7eb95f57b48b0dd48f23.png](https://s1.imagehub.cc/images/2023/11/19/c64fdfe04fda7eb95f57b48b0dd48f23.png)](https://www.imagehub.cc/image/1OG6So)
  ***trace15***
  [![9f1beb9b7832bf0d0369d56516600092.png](https://s1.imagehub.cc/images/2023/11/19/9f1beb9b7832bf0d0369d56516600092.png)](https://www.imagehub.cc/image/1OGBNR)
  ***trace16***
  [![e6cc5c6ce9934c524027734b9e6abd05.png](https://s1.imagehub.cc/images/2023/11/19/e6cc5c6ce9934c524027734b9e6abd05.png)](https://www.imagehub.cc/image/1OGNkb)

- å®ç°è¿‡ç¨‹

  ä¸‹é¢æ˜¯æ­¤ä»»åŠ¡æ—¶é—´çº¿ï¼š

â€‹			[![3e983c332aac794685627d620fb82a7f.png](https://s1.imagehub.cc/images/2023/11/19/3e983c332aac794685627d620fb82a7f.png)](https://www.imagehub.cc/image/1OG9kS)

### å…­ å®éªŒå¿ƒå¾—

åœ¨å®Œæˆè¿™ä¸ªå®éªŒçš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘å¯¹æ“ä½œç³»ç»Ÿä¸­çš„ä½œä¸šæ§åˆ¶å’Œä¿¡å·å¤„ç†æœ‰äº†æ›´æ·±å…¥çš„ç†è§£ã€‚ä»¥ä¸‹æ˜¯æˆ‘åœ¨å®éªŒä¸­è·å¾—çš„ä¸€äº›å¿ƒå¾—ä½“ä¼šï¼š

1. **ä¿¡å·å¤„ç†çš„é‡è¦æ€§ï¼š** é€šè¿‡å®ç°ä¿¡å·å¤„ç†å‡½æ•°ï¼Œç‰¹åˆ«æ˜¯ `SIGCHLD`ã€`SIGINT`ã€`SIGTSTP` çš„å¤„ç†å‡½æ•°ï¼Œæˆ‘æ›´åŠ ç†è§£ä¿¡å·åœ¨æ“ä½œç³»ç»Ÿä¸­çš„é‡è¦æ€§ã€‚åˆç†åœ°å¤„ç†ä¿¡å·ï¼Œç‰¹åˆ«æ˜¯ä¸ä½œä¸šæ§åˆ¶ç›¸å…³çš„ä¿¡å·ï¼Œæ˜¯å®ç°ä¸€ä¸ªç¨³å®šã€å¯é çš„ shell çš„å…³é”®ã€‚
2. **ä½œä¸šæ§åˆ¶çš„å¤æ‚æ€§ï¼š** å®ç°ä½œä¸šæ§åˆ¶å¹¶ç¡®ä¿æ­£ç¡®åœ°ç®¡ç†å‰å°ä½œä¸šå’Œåå°ä½œä¸šä¹‹é—´çš„çŠ¶æ€è½¬æ¢æ˜¯ä¸€é¡¹ç›¸å¯¹å¤æ‚çš„ä»»åŠ¡ã€‚éœ€è¦è°¨æ…å¤„ç†ä½œä¸šçš„æ·»åŠ ã€åˆ é™¤ä»¥åŠçŠ¶æ€çš„å˜åŒ–ï¼Œä»¥ç¡®ä¿ shell çš„è¡Œä¸ºç¬¦åˆç”¨æˆ·çš„é¢„æœŸã€‚
3. **ç»†èŠ‚å†³å®šæˆè´¥ï¼š** å®éªŒä¸­æœ‰è®¸å¤šç»†èŠ‚éœ€è¦å¤„ç†ï¼Œå¦‚å¤„ç†ä½œä¸šçŠ¶æ€ã€æ­£ç¡®åœ°è§£æå‘½ä»¤è¡Œã€å¤„ç†å†…ç½®å‘½ä»¤ç­‰ã€‚è¿™äº›ç»†èŠ‚çš„å¤„ç†ç›´æ¥å½±å“äº† shell çš„æ­£ç¡®æ€§å’Œç¨³å®šæ€§ã€‚åœ¨å®ç°è¿‡ç¨‹ä¸­ï¼Œä»”ç»†å®¡æŸ¥æ¯ä¸ªå‡½æ•°ã€æ¯ä¸ªé€»è¾‘åˆ†æ”¯ï¼Œç¡®ä¿å®ƒä»¬èƒ½å¤Ÿæ­£ç¡®åœ°å®Œæˆé¢„æœŸçš„åŠŸèƒ½ã€‚
4. **ä»£ç çš„æ¨¡å—åŒ–è®¾è®¡ï¼š** åœ¨å®éªŒä¸­ï¼Œé‡‡ç”¨æ¨¡å—åŒ–çš„è®¾è®¡æ–¹å¼å¯¹ä»£ç è¿›è¡Œç»„ç»‡ï¼Œä½¿å¾—å„ä¸ªåŠŸèƒ½å—åˆ†ç¦»å¼€æ¥ï¼Œä¾¿äºç†è§£å’Œç»´æŠ¤ã€‚å‡½æ•°çš„ç‹¬ç«‹æ€§å’Œå¯å¤ç”¨æ€§å¯¹äºæ•´ä¸ªé¡¹ç›®çš„å¯ç»´æŠ¤æ€§éå¸¸é‡è¦ã€‚
5. **è°ƒè¯•çš„é‡è¦æ€§ï¼š** å®ç°ä¸€ä¸ªåŠŸèƒ½å®Œå–„çš„ shell æ˜¯ä¸€ä¸ªå¤æ‚çš„ä»»åŠ¡ï¼Œéš¾å…ä¼šå‡ºç°å„ç§ bug å’Œé—®é¢˜ã€‚åœ¨è°ƒè¯•è¿‡ç¨‹ä¸­ï¼Œé€šè¿‡è¿ç”¨è°ƒè¯•å·¥å…·ã€è¾“å‡ºè°ƒè¯•ä¿¡æ¯ä»¥åŠé€æ­¥éªŒè¯ä»£ç ï¼Œæˆ‘æˆåŠŸåœ°è§£å†³äº†ä¸€äº›æ½œåœ¨é—®é¢˜ï¼Œæé«˜äº†ä»£ç çš„å¥å£®æ€§ã€‚

å®éªŒè®©æˆ‘æ·±åˆ»è®¤è¯†åˆ°æˆ‘ä»¬æ¯å¤©éƒ½åœ¨ä½¿ç”¨ Shellï¼Œè€Œå®ƒçš„ä¸€ä¸ªæœ€åŸºç¡€çš„ä½œä¸šæ§åˆ¶å°±è¦è€ƒè™‘å¦‚æ­¤å¤šçš„å› ç´ ï¼šå›æ”¶è¿›ç¨‹ã€é¿å…ç«äº‰ç­‰ã€‚è¯» CSAPP ç¬¬ 8 ç« æ—¶ï¼Œæˆ‘å¯¹å¾ˆå¤šåœ°æ–¹éƒ½ä¸ç”šç†è§£ã€‚é€šè¿‡äº²è‡ªç¼–å†™å¤šçº¿ç¨‹çš„ä»£ç ã€è€ƒè™‘å¦‚ä½•é¿å…ç«äº‰ã€ä¸æ–­è°ƒè¯•ç”±äºå¹¶å‘å¸¦æ¥çš„ BUGï¼Œæˆ‘å¯¹ä¹¦ä¸Šçš„ä¾‹ç¨‹ä¸€ä¸‹å­å°±é¢†æ‚Ÿäº†ï¼Œæ„Ÿè°¢ CMU æä¾›çš„å®éªŒææ–™ï¼

è¿™æ˜¯æˆ‘è®¡ç®—æœºç”Ÿæ¶¯ä¸­ç¬¬ä¸€æ¬¡çœŸæ­£æ¥è§¦å¹¶å‘ï¼Œæ‰€ä»¥å¾ˆå¤šåœ°æ–¹åªä¼šç…§çŒ«ç”»è™ï¼Œå¸Œæœ›ä»¥åæˆ‘çš„æ°´å¹³èƒ½ä¸æ–­æé«˜ï¼Œç”šè‡³èƒ½å†™å‡ºåƒ zsh è¿™æ ·å¼ºå¤§çš„ç»ˆç«¯å·¥å…·ã€‚

æ€»çš„æ¥è¯´ï¼Œè¿™ä¸ªå®éªŒä½¿æˆ‘æ›´æ·±å…¥åœ°äº†è§£äº†æ“ä½œç³»ç»Ÿä¸­çš„ä¸€äº›æ ¸å¿ƒæ¦‚å¿µå’ŒæŠ€æœ¯ï¼Œå¹¶æå‡äº†æˆ‘çš„ç¼–ç¨‹å’Œè°ƒè¯•èƒ½åŠ›ã€‚é€šè¿‡ä¸æ–­å…‹æœé—®é¢˜å’ŒæŒ‘æˆ˜ï¼Œæˆ‘æ›´åŠ è‡ªä¿¡åœ°å¤„ç†äº†å¤æ‚çš„ç³»ç»Ÿç¼–ç¨‹ä»»åŠ¡ã€‚





